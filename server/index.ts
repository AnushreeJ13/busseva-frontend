// server/index.ts
import path from "node:path";
import dotenv from "dotenv";
dotenv.config({ path: path.resolve(process.cwd(), "server", ".env") });

import express from "express";
import { Pinecone } from "@pinecone-database/pinecone";
import { RecursiveUrlLoader } from "@langchain/community/document_loaders/web/recursive_url";
import { RecursiveCharacterTextSplitter } from "langchain/text_splitter";
import { GoogleGenAI } from "@google/genai";

const app = express();
app.use(express.json({ limit: "2mb" }));

// --- Config ---
const INDEX_NAME = process.env.PINECONE_INDEX!;
const EMBED_MODEL = "gemini-embedding-001";
const GEN_MODEL = "gemini-1.5-flash";
const SITE_URL = process.env.SITE_URL || "";
const RECRAWL_MS = 6 * 60 * 60 * 1000; // 6h

// --- Logging ---
console.log("[ENV]", {
  GOOGLE_API_KEY: !!process.env.GOOGLE_API_KEY,
  PINECONE_API_KEY: !!process.env.PINECONE_API_KEY,
  PINECONE_INDEX: process.env.PINECONE_INDEX,
  SITE_URL: SITE_URL || "(not set)",
});
app.use((req, _res, next) => { console.log(`[REQ] ${req.method} ${req.url}`); next(); });

// --- Clients ---
const ai = new GoogleGenAI({ apiKey: process.env.GOOGLE_API_KEY! });
const pc = new Pinecone({ apiKey: process.env.PINECONE_API_KEY! });

// --- In-memory stores ---
type Turn = { role: "user" | "model"; text: string };
const SESSIONS = new Map<string, Turn[]>();
let GUIDE_CACHE: { text: string; lang: "hi" | "en"; ts: number } | null = null;

// Helpers
function getSessionId(req: express.Request) {
  return String(req.header("x-session-id") || req.body?.sessionId || "anon");
}
function getHistory(sessionId: string) { return SESSIONS.get(sessionId) ?? []; }
function pushTurn(sessionId: string, turn: Turn) {
  const h = getHistory(sessionId);
  h.push(turn);
  SESSIONS.set(sessionId, h.slice(-12));
}
function toChatHistory(history: Turn[]) {
  return history.map(h => ({ role: h.role, parts: [{ text: h.text }] }));
}

// Health
app.get("/api/health", (_req, res) => res.json({ ok: true }));

// Embeddings helper
async function embedTexts(
  texts: string[],
  taskType: "RETRIEVAL_QUERY" | "RETRIEVAL_DOCUMENT" | "SEMANTIC_SIMILARITY" = "RETRIEVAL_DOCUMENT",
  outputDimensionality?: number
) {
  const resp = await ai.models.embedContent({
    model: EMBED_MODEL,
    contents: texts.length === 1 ? texts[0] : texts,
    config: { taskType, ...(outputDimensionality ? { outputDimensionality } : {}) },
  });
  if ((resp as any).embeddings) return (resp as any).embeddings.map((e: any) => e.values as number[]);
  return [(resp as any).embedding.values as number[]];
}

// Crawl / index (domain‚Äëbound)
async function crawlAndIndex(base: string, depth = 2) {
  if (!base) return { ok: false, reason: "SITE_URL not set" };
  const loader = new RecursiveUrlLoader(base, { maxDepth: depth, preventOutside: true, timeout: 15_000 });
  const docs = await loader.load();
  const splitter = new RecursiveCharacterTextSplitter({ chunkSize: 800, chunkOverlap: 120 });
  const chunks = await splitter.splitDocuments(docs);

  const texts = chunks.map(c => c.pageContent);
  const vectors = await embedTexts(texts, "RETRIEVAL_DOCUMENT");
  console.log("[EMBED_DIM]", vectors[0]?.length);

  const index = pc.Index(INDEX_NAME);
  for (let i = 0; i < vectors.length; i += 50) {
    const batch = vectors.slice(i, i + 50).map((v, j) => ({
      id: `doc-${i + j}`,
      values: v,
      metadata: {
        url: chunks[i + j].metadata?.source || "",
        text: texts[i + j].slice(0, 35000),
      },
    }));
    await index.upsert({ vectors: batch });
  }
  return { ok: true, pages: docs.length, chunks: chunks.length };
}

app.get("/api/crawl", async (req, res, next) => {
  try {
    const base = String(req.query.url || SITE_URL);
    const depth = Number(req.query.depth ?? 2);
    const r = await crawlAndIndex(base, depth);
    res.json(r);
  } catch (e) { next(e); }
});

// Debug
app.get("/api/debug/embed", async (_req, res, next) => {
  try { const v = (await embedTexts(["ping"], "RETRIEVAL_QUERY"))[0]; res.json({ dim: v.length }); }
  catch (e) { next(e); }
});
app.get("/api/debug/query", async (_req, res, next) => {
  try {
    const v = (await embedTexts(["ping"], "RETRIEVAL_QUERY"))[0];
    const index = pc.Index(INDEX_NAME);
    const r = await index.query({ vector: v, topK: 3, includeMetadata: true });
    res.json({ matches: r.matches?.length ?? 0 });
  } catch (e) { next(e); }
});

// Enhanced BusSeva-specific site guide
app.get("/api/guide", async (req, res, next) => {
  try {
    const lang = (String(req.query.lang || "hi") === "hi") ? "hi" : "en";
    if (GUIDE_CACHE && Date.now() - GUIDE_CACHE.ts < 30 * 60 * 1000 && GUIDE_CACHE.lang === lang) {
      return res.json({ text: GUIDE_CACHE.text, lang });
    }

    // Multi-platform BusSeva intents covering all features across platforms
    const intents = [
      // Platform Access
      "app download","mobile app","android app","ios app","web app","website booking","download busseva app","install app","platform access",
      // Core Features
      "features","busseva features","platform features","app features","web features","service features",
      "bus booking","book bus tickets","online booking","ticket booking","seat selection","booking process",
      "live tracking","bus tracking","track my bus","real time tracking","gps tracking","location tracking",
      "payment options","pay online","payment methods","ticket payment","secure payment","payment gateway",
      "cancel booking","refund policy","cancellation charges","modify booking","reschedule ticket",
      "route information","bus routes","available buses","bus timing","schedule","timetable","route map",
      // User Management
      "user registration","account creation","login","profile management","user dashboard",
      "customer support","helpline","contact us","help center","24x7 support","customer care",
      // Driver Platform
      "driver registration","driver app","become driver","driver onboarding","driver dashboard","driver earnings",
      "driver features","driver tools","trip management","driver support","vehicle registration",
      // Safety & Security
      "safety features","emergency contact","sos","passenger safety","secure travel","safety measures",
      "reviews and ratings","feedback","rate journey","service review","quality assurance",
      // Platform Comparison
      "android vs ios","mobile vs web","platform comparison","cross platform","multi device access"
    ];
    
    const index = pc.Index(INDEX_NAME);
    const qVecs = await embedTexts(intents, "RETRIEVAL_QUERY");
    const matches = await Promise.all(qVecs.map(v => index.query({ vector: v, topK: 4, includeMetadata: true })));
    const contexts = matches
      .flatMap(r => (r.matches ?? []).map(m => `Source: ${m.metadata?.url}\n${m.metadata?.text}`))
      .join("\n\n---\n\n")
      .slice(0, 100000);

    const systemInstruction =
      "Create a comprehensive multi-platform BusSeva guide for Indian users covering: 1) Platform access (Android app, iOS app, Web platform), 2) Complete feature comparison across platforms, 3) Step-by-step processes for booking/tracking/payments on each platform, 4) Driver features across platforms, 5) Safety and support options, 6) Platform-specific advantages. Include specific UI elements, button names, and navigation paths for each platform. Do not invent URLs.";

    const prompt = (lang === "hi")
      ? "BusSeva ‡§ï‡•á ‡§≤‡§ø‡§è ‡§è‡§ï complete multi-platform ‡§ó‡§æ‡§á‡§° ‡§¨‡§®‡§æ‡§è‡§Ç ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•ã: 1) ‡§∏‡§≠‡•Ä platforms ‡§ï‡•Ä access (Android App, iOS App, Website), 2) ‡§π‡§∞ platform ‡§ï‡•á features ‡§î‡§∞ ‡§´‡§æ‡§Ø‡§¶‡•á, 3) Booking/Tracking/Payment ‡§ï‡•á steps ‡§π‡§∞ platform ‡§™‡§∞, 4) Driver features ‡§∏‡§≠‡•Ä platforms ‡§™‡§∞, 5) Safety ‡§î‡§∞ Support options, 6) Platform-specific UI elements ‡§î‡§∞ navigation‡•§ ‡§∏‡§∞‡§≤ ‡§≠‡§æ‡§∑‡§æ ‡§Æ‡•á‡§Ç, ‡§¨‡§ø‡§®‡§æ ‡§®‡§è ‡§≤‡§ø‡§Ç‡§ï ‡§¨‡§®‡§æ‡§è‡•§"
      : "Create a comprehensive multi-platform BusSeva guide covering: 1) Platform access methods (Android App, iOS App, Website), 2) Feature comparison across all platforms, 3) Step-by-step processes on each platform, 4) Driver features across platforms, 5) Safety and support options, 6) Platform-specific UI and navigation. Use simple language, no fabricated links.";

    const chat = await ai.chats.create({ model: GEN_MODEL, history: [], systemInstruction });
    let text = "";
    if (contexts.trim().length === 0) {
      // Enhanced multi-platform fallback template for BusSeva
      text = (lang === "hi")
        ? [
            "üöå **BusSeva - ‡§∏‡§≠‡•Ä Platforms ‡§™‡§∞ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß**",
            "",
            "üì± **ANDROID APP**",
            "‚Ä¢ Google Play Store ‡§∏‡•á 'BusSeva' ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç",
            "‚Ä¢ Features: Push notifications, Offline ticket access, GPS tracking, Quick booking",
            "‚Ä¢ Navigation: Bottom tabs ‚Üí Home, Search, Bookings, Profile",
            "‚Ä¢ Booking: Home ‚Üí 'Book Bus' ‚Üí Route selection ‚Üí Seat map ‚Üí Payment",
            "",
            "üçé **iOS APP**", 
            "‚Ä¢ App Store ‡§∏‡•á 'BusSeva' install ‡§ï‡§∞‡•á‡§Ç",
            "‚Ä¢ Features: Face ID/Touch ID login, Apple Pay, Siri shortcuts",
            "‚Ä¢ Interface: Tab bar navigation, Swipe gestures",
            "‚Ä¢ Tracking: 'My Trips' ‚Üí Select journey ‚Üí 'Track Live'",
            "",
            "üíª **WEB PLATFORM (busseva.vercel.app)**",
            "‚Ä¢ Browser ‡§Æ‡•á‡§Ç direct access",
            "‚Ä¢ Features: Large screen booking, Print tickets, Bulk booking",
            "‚Ä¢ Navigation: Top menu ‚Üí Home, Routes, Book Now, Track, Support",
            "‚Ä¢ Advantages: No download needed, Full keyboard support",
            "",
            "üéØ **PLATFORM COMPARISON**",
            "üì± Mobile Apps: Best for quick booking, live notifications, GPS tracking",
            "üíª Web: Perfect for detailed planning, group bookings, office use",
            "",
            "üöó **DRIVER PLATFORM**",
            "üì± Driver Mobile App:",
            "‚Ä¢ Trip management, Route optimization, Earnings tracker",
            "‚Ä¢ Real-time passenger updates, Navigation assistance",
            "üíª Driver Web Dashboard:",
            "‚Ä¢ Detailed analytics, Document management, Schedule planning",
            "",
            "üõ°Ô∏è **SAFETY FEATURES (All Platforms)**",
            "‚Ä¢ SOS button with location sharing",
            "‚Ä¢ Emergency contact integration", 
            "‚Ä¢ Live trip sharing with family",
            "‚Ä¢ 24/7 support chat/call",
            "",
            "üí° **PLATFORM-SPECIFIC TIPS**",
            "üì± Mobile: Enable notifications for updates",
            "üíª Web: Bookmark for quick access",
            "üîÑ Sync: Same account works across all platforms"
          ].join("\n")
        : [
            "üöå **BusSeva - Available Across All Platforms**",
            "",
            "üì± **ANDROID APP**",
            "‚Ä¢ Download 'BusSeva' from Google Play Store",
            "‚Ä¢ Features: Push notifications, Offline tickets, GPS tracking, Quick booking",
            "‚Ä¢ Navigation: Bottom tabs ‚Üí Home, Search, Bookings, Profile", 
            "‚Ä¢ Booking Flow: Home ‚Üí 'Book Bus' ‚Üí Select route ‚Üí Choose seat ‚Üí Pay",
            "",
            "üçé **iOS APP**",
            "‚Ä¢ Install 'BusSeva' from App Store", 
            "‚Ä¢ Features: Face ID/Touch ID, Apple Pay, Siri shortcuts",
            "‚Ä¢ Interface: Tab bar navigation, Swipe gestures",
            "‚Ä¢ Live Tracking: 'My Trips' ‚Üí Select journey ‚Üí 'Track Live'",
            "",
            "üíª **WEB PLATFORM (busseva.vercel.app)**",
            "‚Ä¢ Direct browser access", 
            "‚Ä¢ Features: Large screen view, Print tickets, Bulk booking",
            "‚Ä¢ Navigation: Top menu ‚Üí Home, Routes, Book Now, Track, Support",
            "‚Ä¢ Advantages: No download required, Full keyboard support",
            "",
            "üéØ **PLATFORM COMPARISON**",
            "üì± Mobile Apps: Best for quick booking, live notifications, GPS",
            "üíª Web: Perfect for planning, group bookings, office use",
            "",
            "üöó **DRIVER PLATFORM**", 
            "üì± Driver Mobile App:",
            "‚Ä¢ Trip management, Route optimization, Earnings tracking",
            "‚Ä¢ Real-time passenger communication, GPS navigation",
            "üíª Driver Web Dashboard:",
            "‚Ä¢ Analytics, Document management, Schedule planning",
            "",
            "üõ°Ô∏è **SAFETY FEATURES (All Platforms)**",
            "‚Ä¢ SOS button with location sharing",
            "‚Ä¢ Emergency contacts integration",
            "‚Ä¢ Live trip sharing with family", 
            "‚Ä¢ 24/7 support chat/call",
            "",
            "üí° **PLATFORM-SPECIFIC TIPS**",
            "üì± Mobile: Enable push notifications",
            "üíª Web: Bookmark for quick access", 
            "üîÑ Sync: Same account across all platforms"
          ].join("\n");
    } else {
      const result = await chat.sendMessage(`Instruction:\n${prompt}\n\nContext:\n${contexts}`);
      text = result.response.text();
    }

    GUIDE_CACHE = { text, lang, ts: Date.now() };
    res.json({ text, lang });
  } catch (e) { next(e); }
});

// Enhanced Assistant (RAG Q&A) with BusSeva focus
async function askHandler(req: express.Request, res: express.Response, next: express.NextFunction) {
  try {
    const { query, lang, topK = 8 } = (req.body ?? {}) as { query: string; lang?: string; topK?: number; };
    if (!query) return res.status(400).json({ error: "query required" });

    const sessionId = getSessionId(req);
    const normalized = query.toLowerCase().trim();

    // Explicit guide
    if (normalized === "site_guide") {
      const guideLang = lang === "hi" ? "hi" : "en";
      const resp = await fetch(`${req.protocol}://${req.get("host")}/api/guide?lang=${guideLang}`).then(r => r.json());
      pushTurn(sessionId, { role: "user", text: query });
      pushTurn(sessionId, { role: "model", text: resp.text });
      return res.json({ text: resp.text, sources: [], lang: guideLang, sessionId });
    }

    // Enhanced greeting with multi-platform options
    const isPureGreeting = /^(hi+|hello+|hey+|namaste|‡§®‡§Æ‡§∏‡•ç‡§§‡•á|‡§π‡•á‡§≤‡•ã)$/.test(normalized);
    if (isPureGreeting) {
      const isHindi = /namaste|‡§®‡§Æ‡§∏‡•ç‡§§‡•á|‡§π‡•á‡§≤‡•ã/.test(normalized);
      const generalResponse = isHindi
        ? "‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! BusSeva ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! üöå\n\nüì± **‡§∏‡§≠‡•Ä Platforms ‡§™‡§∞ Available:**\n‚úÖ Android App (Play Store)\n‚úÖ iOS App (App Store)\n‚úÖ Web Platform (Browser)\n\nüéØ **Quick Actions:**\n‚Ä¢ 'Platform ‡§ï‡•à‡§∏‡•á choose ‡§ï‡§∞‡•á‡§Ç?'\n‚Ä¢ 'Features ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?'\n‚Ä¢ 'Booking ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç?'\n‚Ä¢ 'Tracking ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç?'"
        : "Hello! Welcome to BusSeva! üöå\n\nüì± **Available on All Platforms:**\n‚úÖ Android App (Play Store)\n‚úÖ iOS App (App Store) \n‚úÖ Web Platform (Browser)\n\nüéØ **Quick Questions:**\n‚Ä¢ 'How to choose platform?'\n‚Ä¢ 'What are the features?'\n‚Ä¢ 'How to book tickets?'\n‚Ä¢ 'How to track buses?'";
      pushTurn(sessionId, { role: "user", text: query });
      pushTurn(sessionId, { role: "model", text: generalResponse });
      return res.json({ text: generalResponse, sources: [], lang: isHindi ? "hi" : "en", sessionId });
    }

    // Multi-platform and feature-specific responses
    const isPlatformQuery = /\b(app|‡§è‡§™|‡§ê‡§™|web|website|platform|‡§™‡•ç‡§≤‡•á‡§ü‡§´‡•â‡§∞‡•ç‡§Æ|android|ios|iphone|browser|download|‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§°|install|‡§á‡§Ç‡§∏‡•ç‡§ü‡•â‡§≤|mobile|‡§Æ‡•ã‡§¨‡§æ‡§á‡§≤|features|‡§´‡•Ä‡§ö‡§∞‡•ç‡§∏)\b/.test(normalized);
    if (isPlatformQuery && contexts.trim().length === 0) {
      const isHindi = lang === "hi" || /hindi|‡§π‡§ø‡§Ç‡§¶‡•Ä/.test(normalized);
      const platformResponse = isHindi
        ? "üéØ **BusSeva - Platform Selection Guide:**\n\nüì± **MOBILE APPS (Recommended)**\nüü¢ **Android App:**\n‚Ä¢ Play Store ‚Üí 'BusSeva' search ‚Üí Install\n‚Ä¢ Best for: Quick booking, Push notifications, GPS tracking\n‚Ä¢ Features: Offline tickets, Fingerprint login, Voice search\n\nüîµ **iOS App:**\n‚Ä¢ App Store ‚Üí 'BusSeva' search ‚Üí Get\n‚Ä¢ Best for: Apple Pay, Face ID, Siri integration\n‚Ä¢ Features: Widget support, Apple Wallet tickets\n\nüíª **WEB PLATFORM**\n‚Ä¢ Browser ‡§Æ‡•á‡§Ç busseva.vercel.app ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç\n‚Ä¢ Best for: Desktop booking, Group reservations, Printing\n‚Ä¢ Features: Large screen view, Multiple bookings, Easy sharing\n\nüéØ **CHOOSE YOUR PLATFORM:**\nüì± Mobile = Daily travel, Quick access\nüíª Web = Planning, Office booking, Groups\n\n‚ú® **Pro Tip:** Same account works on all platforms!"
        : "üéØ **BusSeva - Platform Selection Guide:**\n\nüì± **MOBILE APPS (Recommended)**\nüü¢ **Android App:**\n‚Ä¢ Play Store ‚Üí Search 'BusSeva' ‚Üí Install\n‚Ä¢ Best for: Quick booking, Push notifications, GPS tracking\n‚Ä¢ Features: Offline tickets, Fingerprint login, Voice commands\n\nüîµ **iOS App:**\n‚Ä¢ App Store ‚Üí Search 'BusSeva' ‚Üí Get\n‚Ä¢ Best for: Apple Pay, Face ID, Siri shortcuts\n‚Ä¢ Features: Widget support, Apple Wallet integration\n\nüíª **WEB PLATFORM**\n‚Ä¢ Visit busseva.vercel.app in browser\n‚Ä¢ Best for: Desktop booking, Group reservations, Printing\n‚Ä¢ Features: Large screen interface, Bulk booking, Easy sharing\n\nüéØ **CHOOSE YOUR PLATFORM:**\nüì± Mobile = Daily travel, On-the-go booking\nüíª Web = Planning ahead, Office use, Groups\n\n‚ú® **Pro Tip:** Your account syncs across all platforms!";
      
      pushTurn(sessionId, { role: "user", text: query });
      pushTurn(sessionId, { role: "model", text: platformResponse });
      return res.json({ text: platformResponse, sources: [], lang: isHindi ? "hi" : "en", sessionId });
    }

    // A) Embed query
    let qVec: number[];
    try { qVec = (await embedTexts([query], "RETRIEVAL_QUERY"))[0]; }
    catch (e) { console.error("[EMBED] failed", e); return res.status(502).json({ error: "Embedding failed" }); }

    // B) Vector search
    let search: any;
    try {
      const index = pc.Index(INDEX_NAME);
      search = await index.query({ vector: qVec, topK, includeMetadata: true });
    } catch (e) { console.error("[PINECONE] failed", e); return res.status(502).json({ error: "Vector search failed" }); }

    const contexts = (search.matches ?? [])
      .map((m: any) => `Source: ${m.metadata?.url}\n${m.metadata?.text}`)
      .join("\n\n---\n\n")
      .slice(0, 120000);

    const sources = (search.matches ?? []).slice(0, 5).map((m: any) => m.metadata?.url);

    // C) Grounded answer with BusSeva context
    let text = "";
    if (contexts.trim().length === 0) {
      const isHindi = lang === "hi" || /hindi|‡§π‡§ø‡§Ç‡§¶‡•Ä/.test(normalized);
      text = isHindi
        ? " BusSeva ‡§∏‡•á ‡§ú‡•Å‡§°‡§º‡•á ‡§∏‡§µ‡§æ‡§≤ ‡§ú‡•à‡§∏‡•á:\n‚Ä¢ App ‡§ï‡•à‡§∏‡•á ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç?\n‚Ä¢ Bus booking ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç?\n‚Ä¢ Live tracking ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç?\n‚Ä¢ Payment ‡§ï‡•á ‡§§‡§∞‡•Ä‡§ï‡•á ‡§ï‡•ç‡§Ø‡§æ ‡§π‡•à‡§Ç?\n‚Ä¢ Driver registration ‡§ï‡•à‡§∏‡•á ‡§ï‡§∞‡•á‡§Ç?"
        : "BusSeva-related questions like:\n‚Ä¢ How to download the app?\n‚Ä¢ How to book bus tickets?\n‚Ä¢ How to use live tracking?\n‚Ä¢ What payment methods are available?\n‚Ä¢ How to register as driver?";
    } else {
      try {
        const chat = await ai.chats.create({
          model: GEN_MODEL,
          history: toChatHistory(getHistory(sessionId)),
          systemInstruction: "You are BusSeva multi-platform assistant. Always provide platform-specific guidance (Android app, iOS app, Web). Mention UI elements, navigation paths, and platform advantages. For booking/tracking/payments, give step-by-step instructions for each platform. Prioritize user's preferred platform but mention alternatives. Be concise, practical, and helpful for Indian travelers.",
        });
        const result = await chat.sendMessage(`Question:\n${query}\n\nBusSeva Context:\n${contexts}`);
        text = result.response.text();
      } catch (e) {
        console.error("[GEMINI] generate failed", e);
        text = "Context retrieved, but generation failed; please try again shortly.";
      }
    }

    pushTurn(sessionId, { role: "user", text: query });
    pushTurn(sessionId, { role: "model", text });
    res.json({ text, sources, lang, sessionId });
  } catch (err) { next(err); }
}

app.post("/api/ask", askHandler);
app.post("/api/assistant", askHandler);

// Errors
app.use((err: any, _req: express.Request, res: express.Response, _next: express.NextFunction) => {
  console.error("[ERR]", err?.message, err?.stack);
  res.status(500).json({ ok: false, error: String(err?.message || err) });
});

// Boot: auto-crawl + periodic refresh
app.listen(process.env.PORT || 3000, async () => {
  console.log("üöå BusSeva server up on " + (process.env.PORT || 3000));
  try {
    if (SITE_URL) {
      console.log("[BOOT] Crawling", SITE_URL);
      await crawlAndIndex(SITE_URL, 2);
      setInterval(() => crawlAndIndex(SITE_URL, 2).catch(console.error), RECRAWL_MS);
    }
  } catch (e) { console.error("[BOOT] Crawl failed", e); }
});